<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> Database backup strategies - Lakshay Kalbhor </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="" />
    <meta property="og:site_name" content="Lakshay Kalbhor" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://kalbhor.xyz/blog/database-backup-strategies/" />
    <meta property="og:title" content="Database backup strategies" />
    <meta property="og:image" content="https://kalbhor.xyz" />
    <meta property="og:description" content="" />

    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:title" content="Database backup strategies" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:image" content="https://kalbhor.xyz" />

    <link rel="canonical" href="https://kalbhor.xyz/blog/database-backup-strategies/">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://kalbhor.xyzcss/custom.css" />

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github-gist.min.css" integrity="sha512-od7JLoOTxM8w/HSKGzP9Kexc20K9p/M2zxSWsd7H1e4Ctf+8SQFtCWEZnW5u6ul5ehSECa5QmOk9ju2nQMmlVA==" crossorigin="anonymous" />
    

    

    <link rel="shortcut icon"
        href="https://kalbhor.xyz/images/favicon.png">

    
    <link href="https://kalbhor.xyz/index.xml" rel="alternate" type="application/rss+xml" title="Lakshay Kalbhor" />
    
</head>

<body>
    
<div class="mt-xl header">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-auto">
                <a href="https://kalbhor.xyz">
                    <h1 class="name">kalbhor.xyz</h1>
                </a>
            </div>
        </div>

        <div class="row justify-content-center">
            <ul class="nav nav-primary">
                
                <li class="nav-item">
                    <a class="nav-link" href="https://kalbhor.xyz/">
                        
                        Home
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="https://kalbhor.xyz/about/">
                        
                        About
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="https://github.com/kalbhor">
                        
                        GitHub
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="https://twitter.com/lakshaykalbhor">
                        
                        Twitter
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" href="https://kalbhor.xyz/index.xml">
                        
                        Subscribe
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

<div class="content">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-sm-12 col-lg-8">
                <h1 class="mx-0 mx-md-4 blog-post-title">Database backup strategies</h1>

                <div class="mb-md-4 meta">
                    
                    
                    <span class="author" title="Lakshay Kalbhor">
                        Lakshay Kalbhor
                    </span>
                    
                    

                    <span class="date middot" title='Fri Jul 19 2019 00:00:00 UTC'>
                        2019-07-19
                    </span>

                    <span class="reading-time middot">
                        4 min read
                    </span>

                    <div class="d-none d-md-inline tags">
                        <ul class="list-unstyled d-inline">
                            
                        </ul>
                    </div>
                </div>

                <div class="markdown blog-post-content">
                    
    <p>Recently I started interning at Avanti Learning Centres, an Indian startup focussing on providing interesting and lucid ways of learning. Think of Khan Academy, but focused towards the Indian audience.</p>
<p>One of my first tasks as an intern was to automate the backing up of their databases. I had to look at the problem broadly and list out the standard ways of taking database backups, and then choose a method that would work best.</p>
<p>Avanti uses mongodb and redis for their database &amp; caching requirements. Both services run on separate EC2 instances (All MongoDB databases are on 1 instance and all Redis related stuff is on 1 instance).</p>
<p>So, for this problem we do not have to consider sharded or distributed clusters of databases.</p>
<p><em>phew</em></p>
<h3 id="when-it-comes-to-backing-up-data-there-are-3-strategies-speaking-broadly-">When it comes to backing up data, there are 3 strategies (speaking broadly) :</h3>
<ol>
<li>
<p>Backing up an entire volume using Linux’s LVM functionality (Offered as EBS Snapshots by AWS)</p>
</li>
<li>
<p>Using a database specific tool such as mongodump , sql-dump</p>
</li>
<li>
<p>Using something simple such as cp or rsync</p>
</li>
</ol>
<h3 id="the-key-requirements-from-the-back-up-strategy-at-avanti-were">The key requirements from the back up strategy at Avanti were:</h3>
<ol>
<li>
<p>Should be simple to automate and perform frequently</p>
</li>
<li>
<p>Shouldn’t cause any downtime</p>
</li>
<li>
<p>Shouldn’t be very memory intensive</p>
</li>
<li>
<p>Should be easy to restore</p>
</li>
</ol>
<p>Through these key considerations, option 3 was out. It was tough to automate, and would cause down time since cp &amp; rsync are not atomic operations.</p>
<p>Now, to choose between option #1 and #2, it is important to understand how each works.</p>
<h3 id="ebs-snapshots">EBS Snapshots</h3>
<p>EBS snapshots work by saving backups incrementally.
When an EBS snapshot is created, only the data on the EBS volume that has changed since the last EBS snapshot is stored in the new EBS snapshot.</p>
<p>When an EBS snapshot is used to restore data, all data from that EBS snapshot can be restored as well as the data from the previous snapshots. In this way, the snapshot is a full backup.</p>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*sOSrz9nP0L7gedHNIh5PcQ.png" alt=""></p>
<p>Snapshots can also be deleted (to save space &amp; reduce storage costs). AWS chains together and moves the missing data ahead accordingly. Hence, at any point of time irrespective of the number of deletions, EBS snapshots can recover the entire volume.</p>
<p>Writes on the filesystem should be suspended while a snapshot is taken. For this, MongoDB has an interesting solution in the form of journaling. Understanding how Mongo handles suspending writes without any downtime is out of the scope of this blog post. But here’s a <a href="https://www.mongodb.com/blog/post/how-mongodbs-journaling-works">nice explanation</a>.</p>
<h3 id="mongodump">Mongodump</h3>
<p>Mongodump is a CLI tool that dumps the corresponding database in BSON format (Binary JSON). This data dump can then be stored wherever required (Upload to S3, etc).</p>
<p>A few problems with this approach include :</p>
<ol>
<li>
<p><strong>Point of propogation &amp; flow</strong>. This command runs on the instance we’re backing up. The dump is first stored on the same file system and then a transfer to S3 is initiated. In this process, the backup lives on the instance for too long. (We don’t want that)</p>
</li>
<li>
<p>Lots of points of failures. mongodump could fail, the part where it dumps to the disk could fail, the scheduled upload to S3 could fail.</p>
</li>
<li>
<p>No way to take incremental backups (at least no solution that is industry backed)</p>
</li>
</ol>
<p><img src="https://cdn-images-1.medium.com/max/2000/1*E4EC8meEOAlemH-LtdHqMA.jpeg" alt=""></p>
<p>It was pretty clear that option #1 made the most sense, since it fulfilled pretty much all the requirements.</p>
<h2 id="the-final-implementation">The Final Implementation</h2>
<p>After deciding that EBS Snapshots was the way to go, it was time to write a script that automatically took snapshots. I used aws cli(a command-line tool provided by aws) and a simple shell script that took snapshots of specific instances and purged snapshots older than 7 days.</p>
<p>The script followed the following steps :</p>
<ul>
<li>
<p>Determine the instance ID of the EC2 servers (By checking Scheduled-Snapshots tag)</p>
</li>
<li>
<p>Gather a list of all volume IDs attached to that instance</p>
</li>
<li>
<p>Take a snapshot of each attached volume</p>
</li>
<li>
<p>The script will then delete all associated snapshots taken by the script that are older than 7 days</p>
</li>
</ul>
<p>This script coupled in a cron job made sure that it ran at specific intervals of time. It is important that this script ran somewhere seperate from the actual database servers; we decided that the reverse proxy server suited this purporse.</p>
<h2 id="the-consequence">The Consequence</h2>
<p><strong>Avanti now has timely backups of their databases!</strong>
Another side effect of this new backup process was that it made it easier to sync staging and production database environments.</p>
<p><img src="https://cdn-images-1.medium.com/max/3576/1*U6yPjLuLl0eoEzNqZ8bgzg.png" alt=""></p>
<p>The process of restoring a volume from one of these snapshots is as simple as a few clicks.</p>



                </div>

                
            </div>
        </div>
    </div>
</div>

<section id="comments">
    <div class="py-3 content">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-sm-12 col-lg-8">
                    <div class="comments">
                        <script src="https://utteranc.es/client.js" repo=""
                            issue-term="pathname" label="comment" theme="github-light" crossorigin="anonymous" async>
                            </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>



    

    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js" defer></script>
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js" defer></script>
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/stan.min.js" defer></script>
        
        <script>
            window.addEventListener('load', function() {
                hljs.initHighlighting();
            }, true);
        </script>
    

    

    
    
        

    
</body>

</html>
